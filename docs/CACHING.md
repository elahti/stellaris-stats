# GraphQL Caching System

The project implements a three-tier caching strategy using Redis to optimize GraphQL query performance for immutable game state data.

## Caching Architecture

### Tier 1: Response-Level Caching

- **Implementation**: Custom Apollo Server plugin (`src/graphql/responseCache.ts`)
- **Class**: `RedisCache` implementing Apollo's `KeyValueCache` interface
- **Key Prefix**: `graphql:` for all cache entries
- **Key Format**: `graphql:{query-hash}:{variables-hash}` (auto-generated by Apollo)
- **Null Prevention**: Responses containing null values are NOT cached to prevent caching errors

### Tier 2: Field-Level Caching

- **Implementation**: Manual caching in resolvers (`src/graphql/generated/Gamestate.ts`)
- **Cached Fields**:
  - `Gamestate.budget` - Key: `budget:gamestateId:{id}`
  - `Gamestate.planets` - Key: `planets:gamestateId:{id}`
- **Strategy**: Check cache first, on miss load via DataLoader and cache result
- **TTL**: No expiration (immutable data)

### Tier 3: DataLoader Batching with Request-Scoped Cache

- **Location**: `src/graphql/dataloaders/`
- **DataLoaders**:
  - `budgetLoader`: Batches budget queries by gamestateId
  - `planetsLoader`: Batches planet queries by gamestateId
  - `gamestatesLoader`: Batches gamestate queries by saveId
- **Purpose**: Prevent N+1 query problems and provide request-level deduplication
- **Lifecycle**: Created per GraphQL request (request-scoped)
- **Database Functions**: Calls batch query functions like `getBudgetBatch()`, `getPlanetsBatch()`

## Redis Configuration

- **Client**: `ioredis` library configured in `src/redis.ts`
- **Environment Variables**:
  - `STELLARIS_STATS_REDIS_HOST` (default: 'redis')
  - `STELLARIS_STATS_REDIS_PORT` (default: 6379)
  - `STELLARIS_STATS_REDIS_DB` (default: 0)
- **Retry Strategy**: Exponential backoff (50ms × attempts, max 2000ms, 3 max retries)
- **Deployment**: Redis 7.4-alpine container with persistent volume storage, internal network only (no exposed ports)

## Cache Control Directives

- **GraphQL Schema**: Uses `@cacheControl` directive in `graphql/schema.graphql`
- **Cached Types**: `Budget` and `Gamestate` types marked with `@cacheControl` (no maxAge specified)
- **Default Behavior**: No caching unless explicit `@cacheControl` directive present
- **TTL Strategy**: No expiration for immutable types (game state data never changes once stored)

## Cache Invalidation

- **Current Implementation**: None
- **Rationale**: Game state data is immutable - once parsed and stored, it never changes
- **Considerations**: Redis memory may grow over time; consider implementing eviction policy (e.g., `allkeys-lru`) if needed

## Query Flow

```
GraphQL Query
  → Apollo Response Cache (check)
    → Resolver Field-Level Cache (check)
      → DataLoader Request Cache (check)
        → Batch Database Query
          → Store in all cache layers
            → Return result
```
