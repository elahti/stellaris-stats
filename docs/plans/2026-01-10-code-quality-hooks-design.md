# Code Quality Hooks Design

Auto-format and lint files after Claude edits them using PostToolUse hooks.

## Overview

Implement a PostToolUse hook using the `claude-hooks` library that automatically ensures code quality after Claude writes or edits files. The hook auto-fixes formatting and fixable lint issues silently, and blocks only when unfixable errors remain.

## Decisions

| Component | Decision |
|-----------|----------|
| Trigger | PostToolUse on Write, Edit, MultiEdit |
| Behavior | Auto-fix formatting + fixable lint; block on unfixable errors |
| File types | `.ts`, `.tsx`, `.js`, `.jsx`, `.py`, `.css`, `.json`, `.md` |
| Tools | Prettier (JS/TS/CSS/JSON/MD), ESLint (JS/TS), Ruff (Python) |
| Structure | Single unified hook in `.claude/hooks/index.ts` |
| Commands | Direct execution (not via npm scripts) |
| Devcontainer | No changes needed - Bun already installed |

## File Type Routing

| Extension | Format | Lint |
|-----------|--------|------|
| `.ts`, `.tsx`, `.js`, `.jsx` | `npx prettier --write <file>` | `npx eslint --fix <file>` |
| `.py` | `uv run ruff format <file>` | `uv run ruff check --fix <file>` |
| `.css`, `.json`, `.md` | `npx prettier --write <file>` | — |

## Behavior Flow

```
PostToolUse triggered (Write/Edit/MultiEdit)
    ↓
Extract file path from tool result
    ↓
Is file in excluded directory? → Yes → Exit silently
    ↓ No
Match extension to file type
    ↓
Unknown extension? → Yes → Exit silently
    ↓ No
Run formatting tool (prettier/ruff format)
    ↓
Run linting tool with --fix (eslint/ruff check)
    ↓
Check exit code
    ↓
Exit 0? → Yes → Exit silently (success)
    ↓ No
Return { decision: "block", reason: "<error output>" }
```

## Excluded Paths

- `node_modules/`
- `dist/`
- `.claude/`
- `agent/src/agent/graphql_client/` (generated)
- `src/graphql/generated/` (generated)
- `.venv/`, `venv/`, `__pycache__/`

## Error Handling

| Scenario | Behavior |
|----------|----------|
| Tool not found (e.g., `uv` missing) | Log warning, exit silently |
| File doesn't exist (deleted) | Exit silently |
| Timeout (>30s) | Kill process, exit silently with warning |
| Unfixable lint errors | Return `{ decision: "block", reason: "..." }` |

## Working Directory

- **JS/TS/CSS/JSON/MD**: Run from `/workspace`
- **Python**: Run from `/workspace/agent` (where `pyproject.toml` with ruff config lives)

## Files to Create

| File | Purpose |
|------|---------|
| `.claude/hooks/index.ts` | Main hook logic |
| `.claude/hooks/lib.ts` | Type definitions (generated by `npx claude-hooks`) |

## Files to Modify

| File | Change |
|------|--------|
| `.claude/settings.json` | Add hooks configuration |

## Settings.json Hook Configuration

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "command": "bun run .claude/hooks/index.ts"
          }
        ]
      }
    ]
  }
}
```

## Installation Steps

1. Run `npx claude-hooks` to scaffold hook files
2. Replace generated `index.ts` with custom implementation
3. Verify hooks configuration in `.claude/settings.json`
4. Commit all files to repo

## Dependencies

**Already installed in devcontainer:**
- Bun (hook runtime)
- uv (Python tool runner)
- Node.js/npm (for npx prettier/eslint)

**No new dependencies required.**

## References

- [claude-hooks](https://github.com/johnlindquist/claude-hooks) - TypeScript hook scaffolding
- [fcakyon/claude-codex-settings](https://github.com/fcakyon/claude-codex-settings) - Example hook implementations
